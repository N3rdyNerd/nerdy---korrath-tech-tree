<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Korrath Tech Tree v0.3 – Stylized</title>
  <style>
    :root{
      --bg:#0b0f13;--panel:#101722;--muted:#8ea0b8;--accent:#7af0ff;--ok:#58e38c;--warn:#f7b955;--bad:#ff6b6b;--line:#223041;
      --t1-bg:#0e0b09; --t1-edge:#3b2a21; --t1-glow:#7a5a44;
      --t2-bg:#101114; --t2-edge:#2e3a4b; --t2-glow:#5a6f88;
      --t3-bg:#0d141c; --t3-edge:#27435b; --t3-glow:#6aa6d9;
      --t4-bg:#0a131a; --t4-edge:#1f5a65; --t4-glow:#6fe1e9;
      --t5-bg:#091014; --t5-edge:#0e6c85; --t5-glow:#8ff7ff;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:#e5eef9}
    header{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid var(--line);background:linear-gradient(180deg,#0b121a,#0a0e13)}
    header h1{font-size:18px;margin:0;letter-spacing:.06em;text-transform:uppercase}
    header .sub{font-size:12px;color:var(--muted)}
    .wrap{display:grid;grid-template-columns:380px 1fr;min-height:calc(100% - 56px)}
    aside{border-right:1px solid var(--line);padding:16px;background:var(--panel)}
    main{padding:16px;position:relative}
    .panel{background:#0e141d;border:1px solid var(--line);border-radius:12px;padding:12px;margin-bottom:12px}
    .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .row.space{justify-content:space-between}
    .btn{border:1px solid var(--line);background:#111a24;color:#dfe9f7;padding:8px 10px;border-radius:10px;cursor:pointer}
    .btn:disabled{opacity:.45;cursor:not-allowed}
    .btn.primary{border-color:#164b55;background:#0e2a31;color:var(--accent)}
    .btn.good{border-color:#1b4b37;background:#0d221a;color:var(--ok)}
    .btn.warn{border-color:#564316;background:#2a1f0b;color:var(--warn)}
    .knum{padding:6px 10px;border-radius:10px;background:#0f1620;border:1px solid var(--line);min-width:56px;text-align:center}
    .small{font-size:12px}
    .muted{color:var(--muted)}

    /* Tabs */
    .tabs{display:flex;gap:8px}
    .tab{padding:6px 10px;border:1px solid var(--line);border-radius:10px;background:#0f1620;cursor:pointer}
    .tab.active{outline:2px solid var(--accent);background:#0d1520}

    /* Tech grid */
    .grid{display:grid;gap:18px}
    .tier{border-left:2px dashed var(--line);padding-left:12px;position:relative}
    .tier h3{margin:0 0 10px 0;color:var(--accent);font-size:14px;letter-spacing:.05em}
    .nodes{display:grid;grid-template-columns:repeat(auto-fill,minmax(260px,1fr));gap:14px}

    .node{position:relative;border-radius:14px;padding:12px;min-height:118px;border:1px solid var(--line);outline:1px solid transparent;transition:transform .1s ease, box-shadow .2s ease}
    .node:hover{transform:translateY(-1px)}
    .node.locked{opacity:.65;filter:grayscale(.1)}
    .node.hidden{filter:blur(3px) grayscale(.8);opacity:.5}
    .node .name{font-weight:700;margin-bottom:6px}
    .node .desc{color:var(--muted);font-size:12px;line-height:1.35}
    .node .meta{display:flex;gap:8px;margin-top:8px;font-size:12px;flex-wrap:wrap}
    .pill{border:1px solid var(--line);border-radius:999px;padding:2px 8px;background:#0f1620}
    .actions{margin-top:10px;display:flex;gap:8px;flex-wrap:wrap}

    /* Tier skins */
    .t1{background:linear-gradient(180deg,var(--t1-bg),#0b0a08);border-color:var(--t1-edge);box-shadow:0 0 0 1px #201915 inset, 0 0 16px rgba(122,90,68,.12)}
    .t1 .name{letter-spacing:.02em}
    .t1::after{content:"";position:absolute;inset:0;border-radius:14px;outline:1px dashed #4b3329;pointer-events:none;opacity:.6}

    .t2{background:linear-gradient(180deg,var(--t2-bg),#0d0f14);border-color:var(--t2-edge);box-shadow:0 0 0 1px #202a36 inset, 0 0 18px rgba(90,111,136,.15)}
    .t3{background:linear-gradient(180deg,var(--t3-bg),#0b121a);border-color:var(--t3-edge);box-shadow:0 0 0 1px #21384b inset, 0 0 18px rgba(106,166,217,.18)}
    .t4{background:linear-gradient(180deg,var(--t4-bg),#0a1016);border-color:var(--t4-edge);box-shadow:0 0 0 1px #1a4750 inset, 0 0 20px rgba(111,225,233,.22)}
    .t5{background:linear-gradient(180deg,var(--t5-bg),#081015);border-color:var(--t5-edge);box-shadow:0 0 0 1px #0f5b6d inset, 0 0 24px rgba(143,247,255,.28)}
    .t5 .name{text-shadow:0 0 6px rgba(143,247,255,.35)}

    /* Tooltip */
    .tip{position:fixed;z-index:50;pointer-events:none;max-width:340px;background:#0b1119;border:1px solid var(--line);border-radius:10px;padding:10px;box-shadow:0 8px 30px rgba(0,0,0,.45);font-size:12px}
    .tip .tname{font-weight:700;margin-bottom:4px}
    .tip .muted{font-size:11px}

    /* Link layer */
    svg.links{position:absolute;inset:0;pointer-events:none}
  </style>
</head>
<body>
  <header>
    <div>
      <h1>Resonants: Korrath Tech Tree</h1>
      <div class="sub">Group & Individual unlocks • Tier evolution • Hover details • GM flags • Tier gates</div>
    </div>
    <div class="row">
      <div class="tabs">
        <div class="tab active" id="tab_group">Group Tree</div>
        <div class="tab" id="tab_player">Player Tree</div>
      </div>
      <div class="knum" id="contextName">Group</div>
      <div class="knum" id="points">0 pts</div>
      <button class="btn" id="addPoint">+1 pt</button>
      <button class="btn" id="subPoint">-1 pt</button>
      <button class="btn warn" id="resetContext">Reset</button>
      <button class="btn" id="exportContext">Export</button>
      <button class="btn" id="importContext">Import</button>
    </div>
  </header>
  <div class="wrap">
    <aside>
      <div class="panel">
        <div class="row space">
          <div>
            <div class="muted small">GM Controls</div>
            <label class="row small"><input type="checkbox" id="gmMode"/> GM Mode</label>
          </div>
          <button class="btn" id="resetAll">Reset All</button>
        </div>
        <div class="small muted" style="margin-top:6px">GM Mode toggles visibility (Discovered) and world flags. Tier gate: need 5 unlocks in the previous tier.</div>
      </div>

      <div class="panel" id="playersPanel">
        <div class="row space">
          <div>
            <div class="muted small">Players</div>
          </div>
          <div class="row">
            <button class="btn" id="addPlayer">Add</button>
            <button class="btn" id="renamePlayer">Rename</button>
            <button class="btn warn" id="deletePlayer">Delete</button>
          </div>
        </div>
        <div id="players" class="plist"></div>
      </div>

      <div class="panel">
        <div class="muted small">World Flags (requirements)</div>
        <div id="flags"></div>
      </div>

      <div class="panel">
        <div class="small muted">Tips</div>
        <ul class="small">
          <li>Switch tabs for <strong>Group</strong> or <strong>Player</strong> tech.</li>
          <li>Hover a node for full details; click <strong>Unlock</strong> when eligible.</li>
          <li>GM can reveal nodes and set world flags that certain tech requires.</li>
        </ul>
      </div>
    </aside>
    <main>
      <svg class="links" id="linkLayer"></svg>
      <div id="tree" class="grid"></div>
    </main>
  </div>
  <footer>
    v0.3 – Stylized. Data-driven. Edit <code>GROUP_TECH</code>, <code>PERSONAL_TECH</code>, and <code>WORLD_FLAGS</code>.
  </footer>

  <script>
    // ====== DATA ======
    const WORLD_FLAGS = [
      {id:'tools_workshop', name:'Tools & Tech NPC present'},
      {id:'cleared_patrol', name:'Cleared patrol route'},
      {id:'trade_route_1', name:'Brokered trade route'},
      {id:'med_scanners', name:'Medical scanners & medic'},
      {id:'mast_installed', name:'Comm mast installed'},
      {id:'power_core', name:'Power core & stabilizers'}
    ];

    // GROUP TREE
    const GROUP_TECH = [
      // T1
      {id:'g_t1_comm', name:'Scrap Communication Network', tier:1, cost:1, prereqs:[], discovered:true, desc:'Short-range, static-filled comms between party and base.', flags:['mast_installed']},
      {id:'g_t1_workshop', name:'Manual Workshop', tier:1, cost:1, prereqs:[], discovered:true, desc:'Basic tech repairs; -2 DC to repair ancient items.', flags:['tools_workshop']},
      {id:'g_t1_scavpatrol', name:'Scavenger Patrols', tier:1, cost:1, prereqs:[], discovered:true, desc:'NPC teams gather small amounts of scrap weekly.', flags:['cleared_patrol']},
      {id:'g_t1_defpost', name:'Basic Defense Post', tier:1, cost:1, prereqs:[], discovered:true, desc:'One hand-cranked turret or mounted thrower.', cap:2},
      {id:'g_t1_powernode', name:'Jury-Rigged Power Node', tier:1, cost:1, prereqs:[], discovered:true, desc:'Stable power for ONE small facility at a time.', flags:['power_core'], cap:2},
      {id:'g_t1_medbay', name:'Makeshift Medical Bay', tier:1, cost:1, prereqs:[], discovered:true, desc:'+1 to Medicine checks in Refuge; faster downtime recovery.', flags:['med_scanners']},
      {id:'g_t1_trade', name:'Basic Trade Outpost', tier:1, cost:1, prereqs:[], discovered:true, desc:'One trade route to nearby settlement.', flags:['trade_route_1'], cap:2},
      // T2
      {id:'g_t2_microgrid', name:'Stabilized Microgrid', tier:2, cost:2, prereqs:['g_t1_powernode'], discovered:false, desc:'Run two small facilities without switching power.'},
      {id:'g_t2_bikes', name:'Scout Bikes (Scrap Skiffs)', tier:2, cost:2, prereqs:['g_t1_scavpatrol'], discovered:false, desc:'Faster recon and travel speed for NPC patrols.'},
      {id:'g_t2_sentry1', name:'Auto-Sentry Mk.I', tier:2, cost:2, prereqs:['g_t1_defpost'], discovered:false, desc:'Unreliable automated turret that can jam.', cap:2},
      {id:'g_t2_fieldmed', name:'Field Med Station', tier:2, cost:2, prereqs:['g_t1_medbay'], discovered:false, desc:'Portable triage station for on-site stabilization.'},
      {id:'g_t2_guild', name:'Salvage Guild Charter', tier:2, cost:2, prereqs:['g_t1_scavpatrol'], discovered:false, desc:'+20% materials and better leads.'},
      {id:'g_t2_decode', name:'Decoding Lab Alpha', tier:2, cost:2, prereqs:['g_t1_workshop','g_t1_comm'], discovered:false, desc:'Translate simple ancient schematics; unlocks personal blueprints.'},
      {id:'g_t2_logistics', name:'Logistics Depot', tier:2, cost:2, prereqs:['g_t1_trade'], discovered:false, desc:'+1 simultaneous NPC expedition slot.'},
      // T3
      {id:'g_t3_sensor', name:'Perimeter Sensor Net', tier:3, cost:3, prereqs:['g_t2_microgrid'], discovered:false, desc:'Early warning against incursions.'},
      {id:'g_t3_barge', name:'Hover Barge (Short Range)', tier:3, cost:3, prereqs:['g_t2_bikes','g_t2_guild'], discovered:false, desc:'Bulk salvage transport over rough terrain.'},
      {id:'g_t3_medpod', name:'MedPod Beta', tier:3, cost:3, prereqs:['g_t2_fieldmed'], discovered:false, desc:'Rapid trauma recovery; remove one lingering injury per rest.'},
      {id:'g_t3_fab', name:'Fabrication Bay', tier:3, cost:3, prereqs:['g_t2_decode'], discovered:false, desc:'Print standardized parts; reduce project time/costs.'},
      {id:'g_t3_comms', name:'Encrypted Long-Range Comms', tier:3, cost:3, prereqs:['g_t2_decode','g_t2_microgrid'], discovered:false, desc:'Secure contact with distant settlements; unlocks new arcs.'},
      {id:'g_t3_drone', name:'Drone Wing Alpha', tier:3, cost:3, prereqs:['g_t2_bikes','g_t2_logistics'], discovered:false, desc:'Recon and hazard mapping via drones.'},
      {id:'g_t3_envoy', name:'Ambassadorial Corps', tier:3, cost:3, prereqs:['g_t2_logistics'], discovered:false, desc:'Formal envoys for better negotiations.'},
      // T4
      {id:'g_t4_shieldseg', name:'Shield Segment Activation', tier:4, cost:4, prereqs:['g_t3_sensor','g_t3_fab'], discovered:false, desc:'Partial city shielding for certain sectors.'},
      {id:'g_t4_rail', name:'Rail Link (Short Haul)', tier:4, cost:4, prereqs:['g_t3_barge','g_t3_logistics'], discovered:false, desc:'Freight line to nearby hubs; doubles throughput.'},
      {id:'g_t4_fusion', name:'Fusion Core Stabilizers', tier:4, cost:4, prereqs:['g_t3_fab'], discovered:false, desc:'Stable city-scale power to support advanced systems.'},
      {id:'g_t4_autodoc', name:'AutoDoc Wing', tier:4, cost:4, prereqs:['g_t3_medpod'], discovered:false, desc:'High-capacity medical treatment for complex conditions.'},
      {id:'g_t4_gate_local', name:'Gate Pylon Reactivation (Local)', tier:4, cost:4, prereqs:['g_t3_comms','g_t3_sensor'], discovered:false, desc:'Short-hop teleportation to nearby pylons (risky).'},
      {id:'g_t4_defgrid2', name:'Defense Grid Mk.II', tier:4, cost:4, prereqs:['g_t3_sensor','g_t2_sentry1'], discovered:false, desc:'Networked turrets and sensors with no jam risk.'},
      {id:'g_t4_orbital_ping', name:'Orbital Ping (Handshake)', tier:4, cost:4, prereqs:['g_t3_comms'], discovered:false, desc:'Limited comms with orbital assets for intel.'},
      // T5
      {id:'g_t5_cityshield', name:'Citywide Shield', tier:5, cost:5, prereqs:['g_t4_shieldseg','g_t4_fusion'], discovered:false, desc:'Full defensive shield for Refuge.'},
      {id:'g_t5_gatenet', name:'Gate Network Reactivation', tier:5, cost:5, prereqs:['g_t4_gate_local','g_t4_orbital_ping'], discovered:false, desc:'Stable long-range gates to distant hubs.'},
      {id:'g_t5_shuttle', name:'Orbital Shuttle Access', tier:5, cost:5, prereqs:['g_t4_orbital_ping','g_t4_rail'], discovered:false, desc:'Regular shuttle travel to orbital stations.'},
      {id:'g_t5_nanomed', name:'Nanotech Med Bays', tier:5, cost:5, prereqs:['g_t4_autodoc'], discovered:false, desc:'Regenerative care for severe conditions.'},
      {id:'g_t5_ai', name:'AI Civic Core', tier:5, cost:5, prereqs:['g_t4_fusion','g_t4_defgrid2'], discovered:false, desc:'AI-assisted governance and crisis response.'},
      {id:'g_t5_zpreactor', name:'Zero-Point Reactor', tier:5, cost:5, prereqs:['g_t4_fusion'], discovered:false, desc:'Near-unlimited clean power with story risks.'},
      {id:'g_t5_tradecharter', name:'Planetary Trade Charter', tier:5, cost:5, prereqs:['g_t3_envoy','g_t3_comms'], discovered:false, desc:'Refuge recognized as a major planetary hub.'}
    ];

    // PERSONAL TREE
    const PERSONAL_TECH = [
      // T1
      {id:'p_t1_wepcal', name:'Ancient Weapon Calibration', tier:1, cost:1, prereqs:[], discovered:true, desc:'Minor boost to attack rolls with salvaged ancient weapons.'},
      {id:'p_t1_armormod', name:'Basic Armor Mods', tier:1, cost:1, prereqs:[], discovered:true, desc:'Simple plating upgrades; +1 AC vs a specific damage type.'},
      {id:'p_t1_scanner', name:'Tech Scanner', tier:1, cost:1, prereqs:[], discovered:true, desc:'Scan simple relics and terrain hazards.'},
      {id:'p_t1_repair', name:'Field Repair Kit', tier:1, cost:1, prereqs:[], discovered:true, desc:'Repair basic gear in the field; prevent degradation.'},
      {id:'p_t1_ammo', name:'Prototype Ammo', tier:1, cost:1, prereqs:[], discovered:true, desc:'Access a small stock of special ammunition (limited uses).'},
      {id:'p_t1_lang', name:'Language Fragment', tier:1, cost:1, prereqs:[], discovered:true, desc:'Understand a few phrases of ancient language.'},
      {id:'p_t1_comms', name:'Personal Comms Unit', tier:1, cost:1, prereqs:[], discovered:true, desc:'Private encrypted link with one other party member or NPC.'},
      // T2
      {id:'p_t2_energy', name:'Energy Weapon Handling', tier:2, cost:2, prereqs:['p_t1_wepcal'], discovered:false, desc:'Remove disadvantage when using energy weapons.'},
      {id:'p_t2_hud', name:'HUD Targeting System', tier:2, cost:2, prereqs:['p_t1_scanner'], discovered:false, desc:'+1 ranged attack and better rangefinding.'},
      {id:'p_t2_jet', name:'Short-Burst Jetpack', tier:2, cost:2, prereqs:['p_t1_armormod'], discovered:false, desc:'Limited vertical mobility for combat/exploration.'},
      {id:'p_t2_drone1', name:'Combat Drone (Mk.I)', tier:2, cost:2, prereqs:['p_t1_scanner'], discovered:false, desc:'Basic drone for scouting or distraction.'},
      {id:'p_t2_juryrig', name:'Jury-Rig Mods', tier:2, cost:2, prereqs:['p_t1_repair'], discovered:false, desc:'Craft simple mods without a workshop.'},
      {id:'p_t2_datajack', name:'Data Jack Interface', tier:2, cost:2, prereqs:['p_t1_lang'], discovered:false, desc:'Direct plug-in to ancient terminals.'},
      {id:'p_t2_biofilter', name:'Bio-Filter Implant', tier:2, cost:2, prereqs:['p_t1_repair'], discovered:false, desc:'Resistance to common toxins and diseases.'},
      // T3
      {id:'p_t3_heavy', name:'Heavy Weapon Certification', tier:3, cost:3, prereqs:['p_t2_energy'], discovered:false, desc:'Proficiency with large, high-damage ancient weapons.'},
      {id:'p_t3_camo', name:'Adaptive Camouflage', tier:3, cost:3, prereqs:['p_t2_hud'], discovered:false, desc:'Partial invisibility in low light or cover.'},
      {id:'p_t3_drone2', name:'Combat Drone (Mk.II)', tier:3, cost:3, prereqs:['p_t2_drone1'], discovered:false, desc:'Upgraded drone with basic attack capability.'},
      {id:'p_t3_fabricator', name:'Portable Fabricator', tier:3, cost:3, prereqs:['p_t2_juryrig'], discovered:false, desc:'Craft small components or ammo on the move.'},
      {id:'p_t3_override', name:'System Override Protocols', tier:3, cost:3, prereqs:['p_t2_datajack'], discovered:false, desc:'Force unlock sealed doors or disable defenses.'},
      {id:'p_t3_gene', name:'Gene Stabilizer', tier:3, cost:3, prereqs:['p_t2_biofilter'], discovered:false, desc:'Boost a Resonant ability or reduce side effects.'},
      {id:'p_t3_neural', name:'Neural Link', tier:3, cost:3, prereqs:['p_t2_datajack'], discovered:false, desc:'Control one ancient construct briefly.'},
      // T4
      {id:'p_t4_shield', name:'Personal Energy Shield', tier:4, cost:4, prereqs:['p_t3_gene'], discovered:false, desc:'Absorbs a set amount of damage before breaking.'},
      {id:'p_t4_amp', name:'Resonance Amplifier', tier:4, cost:4, prereqs:['p_t3_gene'], discovered:false, desc:'Boost one Resonant power for a short duration.'},
      {id:'p_t4_drone3', name:'Combat Drone (Mk.III)', tier:4, cost:4, prereqs:['p_t3_drone2'], discovered:false, desc:'Fully armed drone with independent targeting.'},
      {id:'p_t4_frame', name:'Advanced Armor Frame', tier:4, cost:4, prereqs:['p_t3_heavy','p_t3_camo'], discovered:false, desc:'Powered armor with strength/mobility boosts.'},
      {id:'p_t4_multideck', name:'Multi-System Control Deck', tier:4, cost:4, prereqs:['p_t3_override'], discovered:false, desc:'Remotely control multiple tech devices at once.'},
      {id:'p_t4_bioaug', name:'Bio-Augment Package', tier:4, cost:4, prereqs:['p_t3_gene'], discovered:false, desc:'Enhanced senses, speed, or minor regeneration.'},
      {id:'p_t4_construct', name:'Ancient Construct Bond', tier:4, cost:4, prereqs:['p_t3_neural'], discovered:false, desc:'Permanent allied construct companion.'},
      // T5
      {id:'p_t5_proto', name:'Prototype Weapon Access', tier:5, cost:5, prereqs:['p_t4_frame','p_t4_drone3'], discovered:false, desc:'One-of-a-kind customizable weapon.'},
      {id:'p_t5_stealth', name:'Full Stealth Suite', tier:5, cost:5, prereqs:['p_t4_bioaug','p_t3_camo'], discovered:false, desc:'Optical camo, sound suppression, heat masking.'},
      {id:'p_t5_swarm', name:'Drone Swarm Deployment', tier:5, cost:5, prereqs:['p_t4_drone3','p_t4_multideck'], discovered:false, desc:'Multiple drones acting in concert.'},
      {id:'p_t5_resonant', name:'Resonant Mastery Implant', tier:5, cost:5, prereqs:['p_t4_amp'], discovered:false, desc:'Greatly amplifies all Resonant abilities.'},
      {id:'p_t5_copilot', name:'Neural Co-Pilot AI', tier:5, cost:5, prereqs:['p_t4_multideck'], discovered:false, desc:'AI assistant for tactics and automation.'},
      {id:'p_t5_psionic', name:'Psionic Energy Manipulation', tier:5, cost:5, prereqs:['p_t4_amp'], discovered:false, desc:'Channel raw psionic energy offense/defense.'},
      {id:'p_t5_mech', name:'Ancient Mech Pilot Rig', tier:5, cost:5, prereqs:['p_t4_frame','p_t4_multideck'], discovered:false, desc:'Personal mech unit for short deployments.'}
    ];

    // ====== STATE ======
    const LS_KEY = 'korrath_tech_state_v03_stylized';

    const makePlayer = (name) => ({ id: crypto.randomUUID(), name, points: 0, unlocked: [] });

    const defaultDiscoveredGroup = new Set(GROUP_TECH.filter(t=>t.discovered).map(t=>t.id));
    const defaultDiscoveredPersonal = new Set(PERSONAL_TECH.filter(t=>t.discovered).map(t=>t.id));

    const State = {
      gmMode:false,
      mode:'group', // 'group' | 'player'
      world:{ flags:{} },
      group:{ points:0, unlocked:[], discovered:[...defaultDiscoveredGroup], counts:{} },
      personalDiscovered:[...defaultDiscoveredPersonal],
      players:{ byId:{}, order:[] },
      activePlayerId:null
    };

    // init flags
    WORLD_FLAGS.forEach(f=> State.world.flags[f.id]=false);

    function loadState(){
      const raw = localStorage.getItem(LS_KEY);
      if(!raw){
        const p = makePlayer('Party');
        State.players.byId[p.id]=p; State.players.order=[p.id]; State.activePlayerId=p.id; saveState(); return;
      }
      try{
        const s = JSON.parse(raw);
        Object.assign(State, s);
        // ensure discoveries include defaults
        const sgd=new Set(State.group?.discovered||[]); defaultDiscoveredGroup.forEach(x=>sgd.add(x)); State.group.discovered=[...sgd];
        const spd=new Set(State.personalDiscovered||[]); defaultDiscoveredPersonal.forEach(x=>spd.add(x)); State.personalDiscovered=[...spd];
        if(!State.group.counts) State.group.counts={};
      }catch(e){ console.warn('parse',e); }
    }
    function saveState(){ localStorage.setItem(LS_KEY, JSON.stringify(State)); }

    const activePlayer = ()=> State.players.byId[State.activePlayerId] || null;

    // ====== HELPERS ======
    const groupByTier = (arr)=>{ const m=new Map(); for(const t of arr){ if(!m.has(t.tier)) m.set(t.tier,[]); m.get(t.tier).push(t);} return [...m.entries()].sort((a,b)=>a[0]-b[0]); };
    function countUnlockedByTier(unlockedIds, dataset){ const by={}; for(const id of unlockedIds){ const n=dataset.find(x=>x.id===id); if(!n) continue; by[n.tier]=(by[n.tier]||0)+1; } return by; }
    function tierGateOk(node, unlockedByTier){ if(node.tier===1) return true; return (unlockedByTier[node.tier-1]||0) >= 5; }
    function flagsOk(node){ if(!node.flags||!node.flags.length) return true; return node.flags.every(fid=> !!State.world.flags[fid]); }

    function canUnlockGroup(node){
      if(!new Set(State.group.discovered).has(node.id)) return false;
      if(State.group.unlocked.includes(node.id)) return false;
      if(!flagsOk(node)) return false;
      const byTier = countUnlockedByTier(State.group.unlocked, GROUP_TECH);
      if(!tierGateOk(node, byTier)) return false;
      if(node.prereqs && !node.prereqs.every(id=> State.group.unlocked.includes(id))) return false;
      if(node.cost > State.group.points) return false;
      if(node.cap){ const c = State.group.counts[node.id]||0; if(c>=node.cap) return false; }
      return true;
    }
    function canUnlockPersonal(player, node){
      if(!new Set(State.personalDiscovered).has(node.id)) return false;
      if(player.unlocked.includes(node.id)) return false;
      const byTier = countUnlockedByTier(player.unlocked, PERSONAL_TECH);
      if(!tierGateOk(node, byTier)) return false;
      if(node.prereqs && !node.prereqs.every(id=> player.unlocked.includes(id))) return false;
      if(node.cost > player.points) return false;
      return true;
    }

    // Explain why a node can't be unlocked yet
    function missingReasons(node){
      const isGroup = State.mode==='group';
      const reasons = [];
      const dataset = isGroup ? GROUP_TECH : PERSONAL_TECH;
      const unlocked = isGroup ? State.group.unlocked : (activePlayer()?.unlocked||[]);
      const points = isGroup ? State.group.points : (activePlayer()?.points||0);

      // discovery handled by UI blur; no reason needed

      // Tier gate
      const byTier = countUnlockedByTier(unlocked, dataset);
      if(!tierGateOk(node, byTier)){
        const need = 5 - (byTier[node.tier-1]||0);
        reasons.push(`Unlock ${need} more in Tier ${node.tier-1}`);
      }

      // Prereqs
      if(node.prereqs && node.prereqs.length){
        const missing = node.prereqs.filter(id=> !unlocked.includes(id));
        if(missing.length){
          const names = missing.map(id=> (dataset.find(n=>n.id===id)?.name||id)).join(', ');
          reasons.push(`Missing prereq: ${names}`);
        }
      }

      // Flags (group only)
      if(isGroup && node.flags && node.flags.length){
        const fMissing = node.flags.filter(fid=> !State.world.flags[fid]).map(fid=> WORLD_FLAGS.find(f=>f.id===fid)?.name || fid);
        if(fMissing.length){ reasons.push(`World req: ${fMissing.join(', ')}`); }
      }

      // Points
      if(points < node.cost){ reasons.push(`Need ${node.cost - points} more point(s)`); }

      // Cap (group only)
      if(isGroup && node.cap){ const c = State.group.counts[node.id]||0; if(c>=node.cap) reasons.push(`Cap reached: ${c}/${node.cap}`); }

      return reasons;
    }

    // ====== RENDER ======
    const elTree = document.getElementById('tree');
    const elPoints = document.getElementById('points');
    const elGM = document.getElementById('gmMode');
    const elPlayers = document.getElementById('players');
    const elActiveName = document.getElementById('contextName');
    const elPlayersPanel = document.getElementById('playersPanel');
    const elFlags = document.getElementById('flags');
    const elLinks = document.getElementById('linkLayer');

    function renderFlags(){
      elFlags.innerHTML='';
      WORLD_FLAGS.forEach(f=>{
        const row = document.createElement('div'); row.className='row small muted';
        const ck = document.createElement('input'); ck.type='checkbox'; ck.checked=!!State.world.flags[f.id]; ck.disabled=!State.gmMode;
        ck.onchange = ()=>{ State.world.flags[f.id]=ck.checked; saveState(); render(); };
        const label = document.createElement('span'); label.textContent=f.name;
        row.appendChild(ck); row.appendChild(label); elFlags.appendChild(row);
      });
    }

    function tierClass(t){ return ['','t1','t2','t3','t4','t5'][t] || 't1'; }

    function render(){
      const isGroup = State.mode==='group';
      elActiveName.textContent = isGroup ? 'Group' : (activePlayer()?.name || '—');
      elPoints.textContent = (isGroup ? State.group.points : (activePlayer()?.points||0)) + ' pts';
      elGM.checked = State.gmMode;
      document.getElementById('tab_group').classList.toggle('active', isGroup);
      document.getElementById('tab_player').classList.toggle('active', !isGroup);
      elPlayersPanel.style.display = isGroup ? 'none' : 'block';

      // Players list
      elPlayers.innerHTML = '';
      State.players.order.forEach(pid=>{
        const pl = State.players.byId[pid]; if(!pl) return;
        const row = document.createElement('div'); row.className='pitem'+(pid===State.activePlayerId?' active':'');
        const left = document.createElement('div');
        const nm = document.createElement('div'); nm.className='pname'; nm.textContent=pl.name;
        const sub = document.createElement('div'); sub.className='small muted'; sub.textContent = `${pl.points} pts • ${pl.unlocked.length} unlocked`;
        left.appendChild(nm); left.appendChild(sub);
        const sel = document.createElement('button'); sel.className='btn'; sel.textContent='Use'; sel.onclick=()=>{ State.activePlayerId=pid; render(); };
        row.appendChild(left); row.appendChild(sel);
        elPlayers.appendChild(row);
      });

      renderFlags();

      // Tech grid
      elTree.innerHTML='';
      const data = isGroup ? GROUP_TECH : PERSONAL_TECH;
      const discovered = isGroup ? new Set(State.group.discovered) : new Set(State.personalDiscovered);
      const tiers = groupByTier(data);
      const byTierCounts = isGroup ? countUnlockedByTier(State.group.unlocked, GROUP_TECH) : countUnlockedByTier(activePlayer()?.unlocked||[], PERSONAL_TECH);

      const nodeEls = new Map();

      tiers.forEach(([tier, nodes])=>{
        const col = document.createElement('section'); col.className='tier'; col.innerHTML = `<h3>Tier ${tier} (${byTierCounts[tier]||0} unlocked)</h3>`;
        const wrap = document.createElement('div'); wrap.className='nodes';
        nodes.forEach(n=>{ const el = renderNode(n, discovered, byTierCounts); nodeEls.set(n.id, el); wrap.appendChild(el); });
        col.appendChild(wrap); elTree.appendChild(col);
      });

      // After DOM paints, draw links
      requestAnimationFrame(()=> drawLinks(data, nodeEls, discovered));

      saveState();
    }

    function makeTooltipContent(node){
      const isGroup = State.mode==='group';
      const reqs = (node.prereqs&&node.prereqs.length)? `Prereqs: ${node.prereqs.length}` : 'No prereqs';
      const cap = node.cap? ` • Cap ${node.cap}`:'';
      const flags = (node.flags&&node.flags.length)? ` • ${node.flags.length} world req` : '';
      const avail = isGroup ? canUnlockGroup(node) : (activePlayer()? canUnlockPersonal(activePlayer(), node): false);
      const reasons = avail ? '' : missingReasons(node).map(r=>`• ${r}`).join('<br>');
      const extra = reasons ? `<div class=\"muted\" style=\"margin-top:6px\"><em>Blocked:</em><br>${reasons}</div>` : '';
      return `<div class=\"tname\">${node.name}</div><div class=\"muted\">Tier ${node.tier} • Cost ${node.cost}${cap}${flags}</div><div style=\"margin-top:6px\">${node.desc||''}</div><div class=\"muted\" style=\"margin-top:6px\">${reqs}</div>${extra}`;
    }

    let tipEl=null;
    function showTip(html,x,y){
      if(!tipEl){ tipEl=document.createElement('div'); tipEl.className='tip'; document.body.appendChild(tipEl); }
      tipEl.innerHTML=html; tipEl.style.left = (x+12)+"px"; tipEl.style.top = (y+12)+"px"; tipEl.style.display='block';
    }
    function hideTip(){ if(tipEl) tipEl.style.display='none'; }

    function renderNode(node, discoveredSet){
      const isGroup = State.mode==='group';
      const div = document.createElement('div');
      div.className = 'node '+tierClass(node.tier);
      div.id = `node_${node.id}`;
      const isDiscovered = discoveredSet.has(node.id);
      const isUnlocked = isGroup ? State.group.unlocked.includes(node.id) : (activePlayer()?.unlocked.includes(node.id)||false);
      const available = isGroup ? canUnlockGroup(node) : (activePlayer()? canUnlockPersonal(activePlayer(), node): false);

      if(!isDiscovered) div.classList.add('hidden');
      if(!available && !isUnlocked) div.classList.add('locked');

      div.innerHTML = `
        <div class=\"name\">${node.name}</div>
        <div class=\"desc\">${node.desc||''}</div>
        <div class=\"meta\">
          <span class=\"pill\">Tier ${node.tier}</span>
          <span class=\"pill\">Cost: ${node.cost}</span>
          <span class=\"pill\">Pre: ${node.prereqs?.length||0}</span>
          ${node.cap?`<span class=\"pill\">Cap: ${node.cap}</span>`:''}
        </div>
        <div class=\"actions\"></div>
      `;

      // Tooltip
      div.addEventListener('mouseenter', (e)=> showTip(makeTooltipContent(node), e.clientX, e.clientY));
      div.addEventListener('mousemove', (e)=> showTip(makeTooltipContent(node), e.clientX, e.clientY));
      div.addEventListener('mouseleave', hideTip);

      const actions = div.querySelector('.actions');

      // Always show a button with reasoning
      let label = 'Unlock';
      let disabled = !available;

      if(node.cap){
        const count = State.group.counts[node.id]||0;
        const canBuildMore = available || (isUnlocked && count < node.cap && State.group.points >= node.cost);
        label = isUnlocked? `Build (+1)` : `Unlock & Build (+1)`;
        disabled = !canBuildMore;
        const b = document.createElement('button'); b.className='btn primary'; b.textContent=label; b.disabled = disabled;
        b.title = disabled ? missingReasons(node).join('\n') : '';
        b.onclick = ()=>{
          if(disabled) return;
          if(!State.group.unlocked.includes(node.id)) State.group.unlocked.push(node.id);
          State.group.points -= node.cost; State.group.counts[node.id]=(State.group.counts[node.id]||0)+1; render();
        };
        const status = document.createElement('span'); status.className='small muted'; status.textContent = `Built ${count}/${node.cap}`;
        actions.appendChild(b); actions.appendChild(status);
      } else {
        const b = document.createElement('button'); b.className = available? 'btn primary':'btn'; b.textContent = isUnlocked? 'Unlocked' : label; b.disabled = isUnlocked ? true : disabled;
        b.title = (!available && !isUnlocked) ? missingReasons(node).join('\n') : '';
        b.onclick = ()=>{
          if(b.disabled) return;
          if(isGroup){ State.group.points -= node.cost; State.group.unlocked.push(node.id); }
          else { const p = activePlayer(); p.points -= node.cost; p.unlocked.push(node.id); }
          render();
        };
        actions.appendChild(b);
      }

      // GM tools
      if(State.gmMode){
        const gmRow = document.createElement('div'); gmRow.className='row small';
        const lab = document.createElement('label'); lab.className='small';
        const ck = document.createElement('input'); ck.type='checkbox'; ck.checked = isDiscovered;
        ck.onchange = ()=>{
          if(isGroup){ const set=new Set(State.group.discovered); ck.checked? set.add(node.id):set.delete(node.id); State.group.discovered=[...set]; }
          else { const set=new Set(State.personalDiscovered); ck.checked? set.add(node.id):set.delete(node.id); State.personalDiscovered=[...set]; }
          render();
        };
        lab.appendChild(ck); lab.append(' Discovered'); gmRow.appendChild(lab);
        const ref = document.createElement('span'); ref.className='small muted'; ref.textContent = `id: ${node.id}`; gmRow.appendChild(ref);
        actions.appendChild(gmRow);
      }

      return div;
    }

    // Draw prereq links between visible nodes
    function drawLinks(dataset, nodeEls, discovered){
      const svg = elLinks;
      const rect = elTree.getBoundingClientRect();
      while(svg.firstChild) svg.removeChild(svg.firstChild);
      svg.setAttribute('viewBox', `0 0 ${rect.width} ${rect.height}`);
      svg.setAttribute('width', rect.width);
      svg.setAttribute('height', rect.height);

      const pathForTier = (tier)=>{
        // rough cable for early tiers, cleaner glow later
        const stroke = [null,'#6e5a47','#5c6f86','#6aa6d9','#6fe1e9','#8ff7ff'][tier]||'#6aa6d9';
        const width  = [0,2,2,2.5,3,3.5][tier]||2;
        const opacity= [0,.5,.55,.6,.75,.85][tier]||.6;
        return {stroke, width, opacity};
      };

      dataset.forEach(n=>{
        if(!n.prereqs||n.prereqs.length===0) return;
        if(!discovered.has(n.id)) return; // only draw to visible nodes
        const tgtEl = document.getElementById(`node_${n.id}`);
        if(!tgtEl) return;
        const tRect = tgtEl.getBoundingClientRect();
        const tX = (tRect.left + tRect.width/2) - rect.left;
        const tY = (tRect.top) - rect.top; // top center of target
        n.prereqs.forEach(pid=>{
          if(!discovered.has(pid)) return; // only from visible prereqs
          const srcEl = document.getElementById(`node_${pid}`);
          if(!srcEl) return;
          const sRect = srcEl.getBoundingClientRect();
          const sX = (sRect.left + sRect.width/2) - rect.left;
          const sY = (sRect.bottom) - rect.top; // bottom center of source
          const path = document.createElementNS('http://www.w3.org/2000/svg','path');
          const d = `M ${sX} ${sY} C ${sX} ${sY+20}, ${tX} ${tY-20}, ${tX} ${tY}`;
          const style = pathForTier(n.tier);
          path.setAttribute('d', d);
          path.setAttribute('fill','none');
          path.setAttribute('stroke', style.stroke);
          path.setAttribute('stroke-width', style.width);
          path.setAttribute('opacity', style.opacity);
          path.setAttribute('stroke-linecap','round');
          if(n.tier>=4){ path.setAttribute('filter','url(#glow)'); }
          svg.appendChild(path);
        });
      });

      // Glow filter
      let defs = svg.querySelector('defs'); if(!defs){ defs=document.createElementNS('http://www.w3.org/2000/svg','defs'); svg.appendChild(defs); }
      defs.innerHTML = `
        <filter id="glow" x="-50%" y="-50%" width="200%" height="200%">
          <feGaussianBlur stdDeviation="3" result="coloredBlur"/>
          <feMerge>
            <feMergeNode in="coloredBlur"/>
            <feMergeNode in="SourceGraphic"/>
          </feMerge>
        </filter>`;
    }

    // ====== EVENTS ======
    document.getElementById('tab_group').onclick = ()=>{ State.mode='group'; render(); };
    document.getElementById('tab_player').onclick = ()=>{ State.mode='player'; render(); };

    document.getElementById('addPoint').onclick = ()=>{ if(State.mode==='group'){ State.group.points++; } else { const p=activePlayer(); if(p) p.points++; } render(); };
    document.getElementById('subPoint').onclick = ()=>{ if(State.mode==='group'){ State.group.points=Math.max(0,State.group.points-1); } else { const p=activePlayer(); if(p) p.points=Math.max(0,p.points-1); } render(); };

    document.getElementById('resetContext').onclick = ()=>{
      if(State.mode==='group'){ if(!confirm('Reset GROUP progress?')) return; State.group.points=0; State.group.unlocked=[]; State.group.counts={}; State.group.discovered=[...defaultDiscoveredGroup]; }
      else { const p=activePlayer(); if(!p) return; if(!confirm(`Reset ${p.name}?`)) return; p.points=0; p.unlocked=[]; }
      render();
    };

    document.getElementById('exportContext').onclick = ()=>{
      const isGroup = State.mode==='group';
      const data = isGroup ? {group:State.group} : {player:activePlayer()};
      const name = isGroup ? 'group' : (activePlayer()?.name.replace(/\s+/g,'_')||'player');
      const blob = new Blob([JSON.stringify(data)],{type:'application/json'});
      const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href=url; a.download=`korrath_${name}.json`; a.click(); URL.revokeObjectURL(url);
    };

    document.getElementById('importContext').onclick = ()=>{
      const inp=document.createElement('input'); inp.type='file'; inp.accept='application/json';
      inp.onchange=(e)=>{ const f=e.target.files?.[0]; if(!f) return; const fr=new FileReader(); fr.onload=()=>{ try{ const obj=JSON.parse(fr.result);
            if(obj.group){ State.group=obj.group; }
            else if(obj.player && obj.player.id){ State.players.byId[obj.player.id]=obj.player; if(!State.players.order.includes(obj.player.id)) State.players.order.push(obj.player.id); State.activePlayerId=obj.player.id; }
            else throw new Error('Unrecognized file'); render(); }catch(err){ alert('Import failed: '+err.message); } }; fr.readAsText(f); };
      inp.click();
    };

    document.getElementById('gmMode').onchange = (e)=>{ State.gmMode = e.target.checked; render(); };

    document.getElementById('resetAll').onclick = ()=>{
      if(!confirm('Reset ALL progress (group, players, flags)?')) return;
      WORLD_FLAGS.forEach(f=> State.world.flags[f.id]=false);
      State.group={ points:0, unlocked:[], discovered:[...defaultDiscoveredGroup], counts:{} };
      for(const pid of State.players.order){ const p=State.players.byId[pid]; if(p){ p.points=0; p.unlocked=[]; } }
      State.personalDiscovered=[...defaultDiscoveredPersonal];
      render();
    };

    document.getElementById('addPlayer').onclick = ()=>{ const name=prompt('New player name:'); if(!name) return; const p=makePlayer(name.trim()); State.players.byId[p.id]=p; State.players.order.push(p.id); State.activePlayerId=p.id; render(); };
    document.getElementById('renamePlayer').onclick = ()=>{ const p=activePlayer(); if(!p) return; const name=prompt('Rename player:', p.name); if(!name) return; p.name=name.trim(); render(); };
    document.getElementById('deletePlayer').onclick = ()=>{ const p=activePlayer(); if(!p) return; if(!confirm(`Delete ${p.name}?`)) return; delete State.players.byId[p.id]; State.players.order=State.players.order.filter(x=>x!==p.id); State.activePlayerId=State.players.order[0]||null; render(); };

    // ====== INIT ======
    loadState();
    render();
    window.addEventListener('resize', ()=> requestAnimationFrame(()=> render()));
  </script>
</body>
</html>
